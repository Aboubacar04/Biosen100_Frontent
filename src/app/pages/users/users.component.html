<div>

  <!-- HEADER -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">ğŸ‘¤ Utilisateurs</h1>
      <p class="text-sm text-gray-500 mt-1">GÃ©rer les comptes admin et gÃ©rants</p>
    </div>
    <button (click)="openCreate()"
      class="bg-gray-800 hover:bg-gray-700 text-white text-sm font-semibold
             px-4 py-2.5 rounded-lg transition-all flex items-center gap-2">
      â• Nouvel utilisateur
    </button>
  </div>

  <!-- SUCCESS / ERROR -->
  @if (successMessage) {
    <div class="bg-green-50 border border-green-300 text-green-700 rounded-lg px-4 py-3 mb-5 text-sm">
      âœ… {{ successMessage }}
    </div>
  }
  @if (errorMessage) {
    <div class="bg-red-50 border border-red-300 text-red-600 rounded-lg px-4 py-3 mb-5 text-sm">
      âš ï¸ {{ errorMessage }}
    </div>
  }

  <!-- TABLEAU -->
  <div class="bg-white rounded-xl shadow overflow-hidden">

    @if (loading) {
      <div class="p-12 text-center text-gray-400">
        <div class="w-8 h-8 border-2 border-gray-300 border-t-gray-800 rounded-full
                    animate-spin mx-auto mb-3"></div>
        Chargement...
      </div>
    } @else {
      <table class="w-full text-sm">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="text-left px-5 py-3 font-semibold text-gray-600">Utilisateur</th>
            <th class="text-left px-5 py-3 font-semibold text-gray-600">RÃ´le</th>
            <th class="text-left px-5 py-3 font-semibold text-gray-600">Boutique</th>
            <th class="text-left px-5 py-3 font-semibold text-gray-600">Statut</th>
            <th class="text-center px-5 py-3 font-semibold text-gray-600">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users; track user.id) {
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition-all">

              <!-- UTILISATEUR -->
              <td class="px-5 py-4">
                <div class="flex items-center gap-3">
                  <div class="w-9 h-9 rounded-full bg-gray-800 text-white flex items-center
                              justify-center text-sm font-bold shrink-0">
                    {{ user.nom.charAt(0).toUpperCase() }}
                  </div>
                  <div>
                    <p class="font-semibold text-gray-800">{{ user.nom }}</p>
                    <p class="text-gray-400 text-xs">{{ user.email }}</p>
                  </div>
                </div>
              </td>

              <!-- RÃ”LE -->
              <td class="px-5 py-4">
                <span class="text-xs px-2.5 py-1 rounded-full font-semibold"
                  [class]="user.role === 'admin'
                    ? 'bg-yellow-100 text-yellow-700'
                    : 'bg-blue-100 text-blue-700'">
                  {{ user.role === 'admin' ? 'ğŸ‘‘ Admin' : 'ğŸª GÃ©rant' }}
                </span>
              </td>

              <!-- BOUTIQUE -->
              <td class="px-5 py-4 text-gray-600">
                {{ user.boutique?.nom ?? '-' }}
              </td>

              <!-- STATUT -->
              <td class="px-5 py-4">
                <button (click)="toggleActif(user)"
                  class="text-xs px-2.5 py-1 rounded-full font-semibold transition-all"
                  [class]="user.actif
                    ? 'bg-green-100 text-green-700 hover:bg-green-200'
                    : 'bg-red-100 text-red-600 hover:bg-red-200'">
                  {{ user.actif ? 'âœ… Actif' : 'ğŸ”´ Inactif' }}
                </button>
              </td>

              <!-- ACTIONS -->
              <td class="px-5 py-4">
                <div class="flex items-center justify-center gap-2">
                  <button (click)="openEdit(user)"
                    class="bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs
                           px-3 py-1.5 rounded-lg transition-all font-semibold">
                    âœï¸ Modifier
                  </button>
                  <button (click)="confirmDelete(user)"
                    class="bg-red-50 hover:bg-red-100 text-red-600 text-xs
                           px-3 py-1.5 rounded-lg transition-all font-semibold">
                    ğŸ—‘ï¸ Supprimer
                  </button>
                </div>
              </td>

            </tr>
          }

          @if (users.length === 0) {
            <tr>
              <td colspan="5" class="px-5 py-12 text-center text-gray-400">
                Aucun utilisateur trouvÃ©
              </td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>
</div>

<!-- ======================================== -->
<!-- MODAL CRÃ‰ER / MODIFIER                   -->
<!-- ======================================== -->
@if (showModal) {
  <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">

      <!-- HEADER MODAL -->
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
        <h2 class="text-lg font-bold text-gray-800">
          {{ isEditing ? 'âœï¸ Modifier l\'utilisateur' : 'â• Nouvel utilisateur' }}
        </h2>
        <button (click)="closeModal()"
          class="text-gray-400 hover:text-gray-600 text-xl transition-all">âœ•</button>
      </div>

      <!-- FORM -->
      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-6">

        <!-- NOM -->
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-1">Nom</label>
          <input type="text" formControlName="nom" placeholder="Nom complet"
            class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg text-sm
                   outline-none focus:border-gray-800 transition-all" />
        </div>

        <!-- EMAIL -->
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
          <input type="email" formControlName="email" placeholder="email@exemple.com"
            class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg text-sm
                   outline-none focus:border-gray-800 transition-all" />
        </div>

        <!-- MOT DE PASSE -->
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-1">
            Mot de passe
            @if (isEditing) {
              <span class="text-gray-400 font-normal">(laisser vide = inchangÃ©)</span>
            }
          </label>
          <input type="password" formControlName="password"
            [placeholder]="isEditing ? 'Laisser vide pour ne pas changer' : 'Minimum 8 caractÃ¨res'"
            class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg text-sm
                   outline-none focus:border-gray-800 transition-all" />
        </div>

        <!-- RÃ”LE -->
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-1">RÃ´le</label>
          <select formControlName="role"
            class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg text-sm
                   outline-none focus:border-gray-800 transition-all bg-white">
            <option value="gerant">ğŸª GÃ©rant</option>
            <option value="admin">ğŸ‘‘ Admin</option>
          </select>
        </div>

        <!-- BOUTIQUE (si gÃ©rant) -->
        @if (roleControl?.value === 'gerant') {
          <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Boutique</label>
            <select formControlName="boutique_id"
              class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg text-sm
                     outline-none focus:border-gray-800 transition-all bg-white"
              [class.border-red-400]="boutiqueControl?.invalid && boutiqueControl?.touched">
              <option [value]="null">-- SÃ©lectionner une boutique --</option>
              @for (boutique of boutiques; track boutique.id) {
                <option [value]="boutique.id">{{ boutique.nom }}</option>
              }
            </select>
            @if (boutiqueControl?.invalid && boutiqueControl?.touched) {
              <p class="text-red-500 text-xs mt-1">Boutique obligatoire pour un gÃ©rant</p>
            }
          </div>
        }

        <!-- STATUT -->
        <div class="mb-6 flex items-center gap-3">
          <input type="checkbox" formControlName="actif" id="actif"
            class="w-4 h-4 accent-gray-800" />
          <label for="actif" class="text-sm font-semibold text-gray-700">
            Compte actif
          </label>
        </div>

        <!-- BOUTONS -->
        <div class="flex gap-3">
          <button type="button" (click)="closeModal()"
            class="flex-1 py-2.5 border-2 border-gray-200 text-gray-600 text-sm
                   font-semibold rounded-lg hover:bg-gray-50 transition-all">
            Annuler
          </button>
          <button type="submit" [disabled]="form.invalid"
            class="flex-1 py-2.5 bg-gray-800 hover:bg-gray-700 text-white text-sm
                   font-semibold rounded-lg transition-all disabled:opacity-50">
            {{ isEditing ? 'Sauvegarder' : 'CrÃ©er' }}
          </button>
        </div>

      </form>
    </div>
  </div>
}

<!-- ======================================== -->
<!-- MODAL CONFIRMER SUPPRESSION              -->
<!-- ======================================== -->
@if (showConfirmDelete) {
  <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
      <div class="text-5xl mb-4">âš ï¸</div>
      <h2 class="text-lg font-bold text-gray-800 mb-2">Confirmer la suppression</h2>
      <p class="text-gray-500 text-sm mb-6">
        Supprimer <strong>{{ userToDelete?.nom }}</strong> ? Cette action est irrÃ©versible.
      </p>
      <div class="flex gap-3">
        <button (click)="showConfirmDelete = false"
          class="flex-1 py-2.5 border-2 border-gray-200 text-gray-600 text-sm
                 font-semibold rounded-lg hover:bg-gray-50 transition-all">
          Annuler
        </button>
        <button (click)="deleteUser()"
          class="flex-1 py-2.5 bg-red-500 hover:bg-red-600 text-white text-sm
                 font-semibold rounded-lg transition-all">
          Supprimer
        </button>
      </div>
    </div>
  </div>
}
